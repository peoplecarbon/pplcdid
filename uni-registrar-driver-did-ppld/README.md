# Universal Registrar Driver: `did:pplc`

This is a [Universal Registrar](https://github.com/decentralized-identity/universal-registrar/) driver for **did:pplc** identifiers. 

The Universal Registrar creates/updates/deactivates Decentralized Identifiers (DIDs) across many different DID methods, based on the [W3C DID Core 1.0](https://www.w3.org/TR/did-core/) and [DID Registration](https://identity.foundation/did-registration/) specifications. 

## Specifications

* [Decentralized Identifiers](https://w3c.github.io/did-core/)    
* [PPLCID Method Specification](https://peoplecarbon.github.io/pplcdid/)    
* [Swagger API definition for Universal Registrar](https://github.com/decentralized-identity/universal-registrar/blob/main/swagger/api-driver.yml)


## Build and Run (Docker)

```
docker build -f ./docker/Dockerfile . --tag peoplecarbon/pplcdid-registrar:<version>
docker run -p 8080:3000 peoplecarbon/pplc-registrar
```

Docker images are available here: https://hub.docker.com/r/peoplecarbon/pplcdid-registrar

### Verify with automated tests    

Use the following command to run the automated tests (including pplcdid-registrar tests) in the [`peoplecarbon/pplcdid-cli`](https://hub.docker.com/r/peoplecarbon/pplcdid-cli) Docker image:    

```bash
docker run -it --rm -w /usr/src/pytest -e PPLDIDCMD=pplcdid peoplecarbon/pplc-cli pytest
```

## Supported DID Operations

In general, each DID operation (create / update / deactivate) can     
* either be used through providing DID and DID Document together with the necessary cryptographic material (private keys),    
* or by sumitting the raw PPLCID data (i.e., PPLCID Document and PPLCID Logs) that does not require to disclose private keys to Uniregistrar.    

In the following sections examples are given for both approaches.

### CREATE Operation

**W3C DID Document and Private Keys**    

The most simple form to create a DID and associated DID Document is to submit a W3C-conform DID Document:

`POST /1.0/create`

```json
{
  "didDocument": {
    "@context": "https://www.w3.org/ns/did/v1",
    "authentication": [],
    "service": [{
      "privacy": "https://data-vault.eu/api/data"
    }]
  }
}
```

<details>

Example command:

```bash
echo '{"didDocument":{"@context":"https://www.w3.org/ns/did/v1", "authentication":[], "service":[{"privacy":"https://data-vault.eu/api/data"}]}}' | curl -H "Content-Type: application/json" -d @- -X POST https://pplc-registrar.peoplecarbon.org/1.0/create
```

DID: [`did:pplc:zQmS3dpwUAJeozNgtAn4E5BT8mk9quGwe92Jrh4MSJMXrAa`](https://pplc-resolver.peoplecarbon.org/1.0/identifiers/did:pplc:zQmS3dpwUAJeozNgtAn4E5BT8mk9quGwe92Jrh4MSJMXrAa)

</details>

*Note:* in the above example no private keys were included in the input and therefore random keys are generated (and provided in the response - see examples in the [Update section](#update) for providing private keys)

**PPLCID Internal Format without Private Keys**    

The same service endpoint can be published in a DID document in the following format:

`POST /1.0/create`

```json
{
  "options": {
    "log_create": {
      "ts": 1647444355,
      "op": 2,
      "doc": "zQmVYEwV3RrfyL7RoStz1iPQ8xDGxxnBQMiecrjm2Rr9qDV",
      "sig": "z2EgqTRL3VA94KdFeTFpK2DsSbpzXFDSCAYQAgevPDHzj7kv5psbBf1ddimWMLZaLjdHkp59MyjkSk8vvVycTTyjG",
      "previous": []
    },
    "log_terminate": {
      "ts": 1647444355,
      "op": 0,
      "doc": "zQmf5WT2u95sBw4hU4eDXW3y5eVVqetxj4Kg4dEjDLqGkkh",
      "sig": "z4dauwSDF8z3FdYLVSkThGG6op8P6DMKmdwSWSADHFtvFjM9rbt46dzmkZ1vjpv3JoYEWKJqvEBM3p6wZEyNjaGa7",
      "previous": []
    }
  },
  "didDocument": {
    "doc": {
      "privacy": "https://data-vault.eu/api/data"
    },
    "key": "z6Mv1FzodAA92zu8Gs5kGjcytQNmY7jpV2QbVGXDToEy4qvy:z6Mv3Mdj1AV5bjAJBwvkbzKa3umeNkB82imaJtuB6Eqgie7V",
    "log": "zQmYTT2qGf7RQS4MAgLc8nB1ZZfot4GDoBRVkZKhYTKNgps"
  }
}
```

<details>

The JSON structure above can be generated by using the `--simulate` option of the [PPLCID CLI](https://github.com/peoplecarbon/pplcdid/tree/main/cli). Use the following command:

```bash
echo '{"privacy": "https://data-vault.eu/api/data"}' | \
  pplcdid create --simulate --doc-pwd myDocPwd --rev-pwd MyRevocationPwd | \
  jq '{options: {log_create: .log_create, log_terminate: .log_terminate}, didDocument: .doc}'
```

Running this tool locally and pre-processing the data does not require to disclose any of your private keys to the Uniregistrar driver.

Example command to submit the data:

```bash
echo '{"options":{"log_create":{"ts":1647444355,"op":2,"doc":"zQmVYEwV3RrfyL7RoStz1iPQ8xDGxxnBQMiecrjm2Rr9qDV","sig":"z2EgqTRL3VA94KdFeTFpK2DsSbpzXFDSCAYQAgevPDHzj7kv5psbBf1ddimWMLZaLjdHkp59MyjkSk8vvVycTTyjG","previous":[]},"log_terminate":{"ts":1647444355,"op":0,"doc":"zQmf5WT2u95sBw4hU4eDXW3y5eVVqetxj4Kg4dEjDLqGkkh","sig":"z4dauwSDF8z3FdYLVSkThGG6op8P6DMKmdwSWSADHFtvFjM9rbt46dzmkZ1vjpv3JoYEWKJqvEBM3p6wZEyNjaGa7","previous":[]}},"didDocument":{"doc":{"privacy":"https://data-vault.eu/api/data"},"key":"z6Mv1FzodAA92zu8Gs5kGjcytQNmY7jpV2QbVGXDToEy4qvy:z6Mv3Mdj1AV5bjAJBwvkbzKa3umeNkB82imaJtuB6Eqgie7V","log":"zQmYTT2qGf7RQS4MAgLc8nB1ZZfot4GDoBRVkZKhYTKNgps"}}' | curl -H "Content-Type: application/json" -d @- -X POST https://pplcdid-registrar.data-container.net/1.0/create
```

</details>

### UPDATE Operation

The update operation requires as input the DID that should be updated and for PPLCID to publish the private revocation record generated when building the original DID. This revocation record can also be re-built using the orginal private keys provided in `secret`.

**W3C DID Document and Private Keys**    

Update a DID by providing the follwing information:

`POST /1.0/update`

```json
{
  "identifier": "did:pplc:zQmPy6LnarRoWyXau5DaL1NX8wn7QWzigx6r8qNUvVF4DgZ",
  "secret": {
    "old_doc_pwd": "myDocPwd",
    "old_rev_pwd": "myRevPwd"
  },
  "didDocument": {
    "@context": "https://www.w3.org/ns/did/v1",
    "service": [{
      "state": "new"
    }]
  }
}
```
<details>

Example command:

```bash
echo '{"identifier":"did:pplc:zQmPy6LnarRoWyXau5DaL1NX8wn7QWzigx6r8qNUvVF4DgZ","secret":{"old_doc_pwd":"myDocPwd","old_rev_pwd":"myRevPwd","doc_pwd":"newDocPwd","rev_pwd":"myRevPwd"},"didDocument":{"@context":"https://www.w3.org/ns/did/v1","service":[{"state":"new"}]}}' | \
    curl -H "Content-Type: application/json" -d @- -X POST https://pplcdid-registrar.data-container.net/1.0/update
```

DID: [`did:pplc:zQmSU6NU1e4tzSP8ti8vAJfUpYh1zL2RASuKJAd1BwT667U`](https://pplc-resolver.data-container.net/1.0/identifiers/did:pplc:zQmSU6NU1e4tzSP8ti8vAJfUpYh1zL2RASuKJAd1BwT667U)

</details>


**PPLCID Internal Format without Private Keys**    

When updating an existing DID Document it is also possible to provide the new version (in `didDocument`) and the relevant PPLCID log entries (in `options`).

`POST /1.0/update`

```json
{
  "identifer": "did:pplc:zQmRgH1oAC6ucvg69ewtTZVaqcUNzx7dasF7nrwonzWhxM4",
  "options": {
    "log_revoke": {
      "ts": 1647444355,
      "op": 2,
      "doc": "zQmVYEwV3RrfyL7RoStz1iPQ8xDGxxnBQMiecrjm2Rr9qDV",
      "sig": "z2EgqTRL3VA94KdFeTFpK2DsSbpzXFDSCAYQAgevPDHzj7kv5psbBf1ddimWMLZaLjdHkp59MyjkSk8vvVycTTyjG",
      "previous": []
    },
    "log_create": {
      "ts": 1647444355,
      "op": 2,
      "doc": "zQmVYEwV3RrfyL7RoStz1iPQ8xDGxxnBQMiecrjm2Rr9qDV",
      "sig": "z2EgqTRL3VA94KdFeTFpK2DsSbpzXFDSCAYQAgevPDHzj7kv5psbBf1ddimWMLZaLjdHkp59MyjkSk8vvVycTTyjG",
      "previous": []
    },
    "log_terminate": {
      "ts": 1647444355,
      "op": 0,
      "doc": "zQmf5WT2u95sBw4hU4eDXW3y5eVVqetxj4Kg4dEjDLqGkkh",
      "sig": "z4dauwSDF8z3FdYLVSkThGG6op8P6DMKmdwSWSADHFtvFjM9rbt46dzmkZ1vjpv3JoYEWKJqvEBM3p6wZEyNjaGa7",
      "previous": []
    }
  },
  "didDocument": {
    "doc": {
      "privacy": "https://data-vault.eu/api/data"
    },
    "key": "z6Mv1FzodAA92zu8Gs5kGjcytQNmY7jpV2QbVGXDToEy4qvy:z6Mv3Mdj1AV5bjAJBwvkbzKa3umeNkB82imaJtuB6Eqgie7V",
    "log": "zQmYTT2qGf7RQS4MAgLc8nB1ZZfot4GDoBRVkZKhYTKNgps"
  }
}
```

<details>

Assume an initial DID created with the following command:

```bash
echo '{"state": "initial"}' | pplcdid create --doc-pwd pwd1 --rev-pwd pwd2
```

Output: `did:pplc:zQmfTxojQjja2gVvnuGEHyWZU6zQAdLLErMt3T8Wei7MfFX`

The JSON structure from above to invoke `POST /1.0/update` can then be generated by using the `--simulate` option of the [PPLCID CLI](https://github.com/peoplecarbon/pplcdid/tree/main/cli) with the following command:

```bash
echo '{"state": "new"}' | \
    pplcdid update did:pplc:zQmfTxojQjja2gVvnuGEHyWZU6zQAdLLErMt3T8Wei7MfFX \
        --simulate --old-doc-pwd pwd1 --old-rev-pwd pwd2 --doc-pwd pwd3 --rev-pwd pwd4 | \
    jq '{identifier: .did_old, options: {log_revoke: .log_revoke_old, log_update: .log_update, log_terminate: .log_terminate}, didDocument: .doc}'
```

Example commands to demonstrate the complete process of creating and updating a DID without disclosing any private keys to the Uniregistrar driver:

```bash
did_v1=`echo '{"state": "initial"}' | pplcdid create --doc-pwd pwd1 --rev-pwd pwd2 --json-output`
echo '{"state": "new"}' | pplcdid update $(echo $did_v1 | jq -r '.did') --simulate --old-doc-pwd pwd1 --old-rev-pwd pwd2 --doc-pwd pwd3 --rev-pwd pwd4 | jq '{identifier: .did_old, options: {log_revoke: .log_revoke_old, log_update: .log_update, log_terminate: .log_terminate}, didDocument: .doc}' | curl -H "Content-Type: application/json" -d @- -X POST http://localhost:3000/1.0/update
```

</details>

### DEACTIVATE Operation

The deactivate operation in PPLCID consists of publishing the associated revocation record. It requires as input the DID that should be revoked and either the private keys or the revocation log record itself.

**W3C DID Document and Private Keys**    

Deactivate a DID by providing the follwing information:

`POST /1.0/deactivate`

```json
{
  "identifier": "did:pplc:zQmPyjnkL52gQxBBhPuCFkf167MzpCKquqbu5Qt5ia2JGTr",
  "secret": {
    "doc_pwd": "pwd1",
    "rev_pwd": "pwd2"
  }
}
```

<details>

Example command:

```bash
echo '{"identifier":"did:pplc:zQmPyjnkL52gQxBBhPuCFkf167MzpCKquqbu5Qt5ia2JGTr","secret":{"doc_pwd":"pwd1","rev_pwd":"pwd2"}}' | \
    curl -H "Content-Type: application/json" -d @- -X POST https://pplcdid-registrar.data-container.net/1.0/deactivate
```

Attempting to resolve this DID will result in a "DID not found" response: [`did:pplc:zQmPyjnkL52gQxBBhPuCFkf167MzpCKquqbu5Qt5ia2JGTr`](https://pplc-resolver.data-container.net/1.0/identifiers/did:pplc:zQmPyjnkL52gQxBBhPuCFkf167MzpCKquqbu5Qt5ia2JGTr)

*Note:* with the `logs` option of the [PPLCID CLI](https://github.com/peoplecarbon/pplcdid/tree/main/cli) it is possible to show the the complete log trail for a deactivated DID:

```bash
pplcdid logs did:pplc:zQmPyjnkL52gQxBBhPuCFkf167MzpCKquqbu5Qt5ia2JGTr
```

Output:

```
[
  {
    "ts": 1647732475,
    "op": 2,
    "doc": "zQmPyjnkL52gQxBBhPuCFkf167MzpCKquqbu5Qt5ia2JGTr",
    "sig": "z5ho1KScnekJHiTcwhNXRPFobcn5JZx83WY1RdCNuBESwfthp1sdZNstqJet5EqqaoihpJwf7EkEkdrkAwS8WmFpP",
    "previous": []
  },
  {
    "ts": 1647732475,
    "op": 0,
    "doc": "zQmZm7wQLv8XR3N4239ie3oWttp7oUJVkg1dmnNb3DFUBNr",
    "sig": "z2Vuwemspoodd95FZ8C4UACTTpTGzt1Zks11oicCmyxahTmund3RhQEYuyouh8wKvc64Yj2U9NGLyTVqSQN5Ddppd",
    "previous": []
  },
  {
    "ts": 1647732475,
    "op": 1,
    "doc": "zQmcVLwEtzU8By7TTeRFGvVUKm7HhZS6GgRTDFt51QNnans",
    "sig": "z2NBimFTYkRGnLy4A7VUKynC7f4Yo7Ygz2CKqr7x4PxgzwfLzVGgZ5CBqN5boGvwospYNCWdE7UGbzqDuNpQVt2GZ",
    "previous": [
      "zQmbP2tto6bnN4fkhSu7rrRKu8LwjFvz7tw5PMSP8byf4jc",
      "zQmfXFsVpQdUReyHjUFzHEUkiugPqAEuCvcp4ueryhoRjGn"
    ]
  }
]
```

</details>

**PPLCID Internal Format without Private Keys**    

For deactivating an existing DID it is also possible to provide the revocation log record.

`POST /1.0/deactivate`

```json
{
  "identifer": "did:pplc:zQmQCoR1HMEBFuc1dzaNpGqMcbpf5zAnJGq8tmoQFrTB4PZ",
  "options": {
    "log_revoke": {
      "ts": 1647444355,
      "op": 2,
      "doc": "zQmVYEwV3RrfyL7RoStz1iPQ8xDGxxnBQMiecrjm2Rr9qDV",
      "sig": "z2EgqTRL3VA94KdFeTFpK2DsSbpzXFDSCAYQAgevPDHzj7kv5psbBf1ddimWMLZaLjdHkp59MyjkSk8vvVycTTyjG",
      "previous": []
    }
}
```

<details>

Assume an initial DID created with the following command:

```bash
echo '{"short": "lived"}' | pplcdid create --doc-pwd pwd1 --rev-pwd pwd2
```

Output: `did:pplc:zQmPbLw9vJzjNHHDNqpnK4rFjisUeXhLFvy7Apm6yWEPKt9`

The JSON structure from above to invoke `POST /1.0/deactivate` can then be generated by using the `--simulate` option of the [PPLCID CLI](https://github.com/peoplecarbon/pplcdid/tree/main/cli) with the following command:

```bash
pplcdid revoke did:pplc:zQmfTxojQjja2gVvnuGEHyWZU6zQAdLLErMt3T8Wei7MfFX \
        --simulate --doc-pwd pwd1 --rev-pwd pwd2 | \
    jq '{identifier: .did, options: {log_revoke: .log_revoke}}'
```

Example commands to demonstrate the complete process of creating and deactivating a DID without disclosing any private keys to the Uniregistrar driver:

```bash
echo '{"short": "lived"}' | \
    pplcdid create --doc-pwd pwd1 --rev-pwd pwd2 --json-output | \
    jq '{identifier: .did, secret:{doc_pwd: "pwd1", rev_pwd:"pwd2"}}' | \
    curl -H "Content-Type: application/json" -d @- -X POST https://pplcdid-registrar.data-container.net/1.0/deactivate
```

</details>

## Driver Input Options

The following additional input data can be provided in requests through `options` and `security`

### Options
```json
{
    "ts": 0,
    "log_create": {},
    "log_update": {},
    "log_terminate": {},
    "log_revoke": {},
    "log_revoke_old": {}
}
```

* `ts`: **timestamp**  (integer) - is the number of seconds that have elapsed since the Unix epoch (1.1.1970)    
* `log_create`: **create PPLCID log entry** (JSON object) - entry for the PPLCID log that contains information for creating a DID    
* `log_update`: **update PPLCID log entry** (JSON object) - entry for the PPLCID log that contains information for updating a DID    
* `log_terminate`: **terminate PPLCID log entry** (JSON object) - entry for the PPLCID log that contains information to determine if their exists an update for the current DID    
* `log_revoke`: **revoke PPLCID log entry** (JSON object) - entry for the PPLCID log that contains information that the associated termination entry does not indiciate that the resolution process is complete    
* `log_revoke_old`: **revoke PPLCID log entry from previous DID version** (JSON object) - entry for the PPLCID log that contains information about the previous DID version    


### Security
```json
{
    "doc_pwd": "string",
    "doc_enc": "string",
    "rev_pwd": "string",
    "rev_enc": "string",
    "old_doc_pwd": "string",
    "old_doc_enc": "string",
    "old_rev_pwd": "string",
    "old_rev_enc": "string"
}
```

* `doc_pwd`: **private document key password**  (string) - password to generate the private key for signing the document payload    
* `doc_enc`: **encoded private document key**  (string) - encoded private key for signing the document payload    
* `rev_pwd`: **private revocation key password**  (string) - password to generate the private key for revocation    
* `rev_enc`: **encoded private revocation key**  (string) - encoded private key for revocation    
* `old_doc_pwd`: **private document key password used in previous DID version**  (string) - password used in the previous DID version to generate the private key for signing the document payload    
* `old_doc_enc`: **encoded private document key used in previous DID version**  (string) - encoded private key used in the previous DID version for signing the document payload    
* `old_rev_pwd`: **private revocation key password used in previous DID version**  (string) - password used in the previous DID version to generate the private key for revocation    
* `old_rev_enc`: **encoded private revocation key used in previous DID version**  (string) - encoded private key used in the previous DID version for revocation    



## Driver Output Metadata

```
{
    "did": "string",
    "registry": "string",
    "log_hash": "string",
    "log": [{}, ...]
}
```

* `did`: **decentralized identifier** (string) - DID of the recently processed entry    
* `registry` **repository URL** (string) - URL of the repository that hosts DID document and log for the currently processed DID    
* `log_hash` **hash value of log entry** (string) - multiformat encoded hash value of the terminate entry for the currently processed DID    
* `log` **log entries** (array of JSON objects) - list of log entries published for the currently processed DID


## License

[Apache Lincense 2.0]